<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bee Swarm Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;600;700&display=swap');
        :root { --bee-yellow: #fbbf24; --bee-orange: #f59e0b; --blue-meta: #3b82f6; }
        body { font-family: 'Lexend', sans-serif; background-color: #fffbeb; overscroll-behavior-y: contain; }
        .bee-gradient { background: linear-gradient(135deg, var(--bee-yellow) 0%, var(--bee-orange) 100%); }
        .card { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border: 1px solid #fef3c7; }
        input, textarea { font-size: 16px !important; min-height: 48px; }
        .tab-active { border-bottom: 4px solid var(--bee-orange); color: #92400e; font-weight: 700; background: white; }
        .chat-bubble-ai { background: #eff6ff; border-radius: 12px 12px 12px 2px; border: 1px solid #dbeafe; }
        .chat-bubble-user { background: #fef3c7; border-radius: 12px 12px 2px 12px; border: 1px solid #fde68a; }
        .image-attachment-preview { width: 40px; height: 40px; border-radius: 8px; object-fit: cover; border: 2px solid #3b82f6; }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center">

    <div class="w-full max-w-xl flex-grow flex flex-col">
        <div class="bee-gradient p-5 shadow-lg text-white text-center sticky top-0 z-50">
            <h1 class="text-2xl font-bold flex items-center justify-center gap-2"><span>üêù</span> BSS Multi-Calculator</h1>
        </div>

        <div class="flex bg-amber-100/50 sticky top-[68px] z-40 border-b border-amber-200 overflow-x-auto whitespace-nowrap scrollbar-hide">
            <button onclick="switchTab('tickets')" id="tab-tickets" class="flex-1 min-w-[100px] py-4 text-[10px] uppercase tracking-wider font-bold text-amber-700 transition-all tab-active">Tickets</button>
            <button onclick="switchTab('treats')" id="tab-treats" class="flex-1 min-w-[100px] py-4 text-[10px] uppercase tracking-wider font-bold text-amber-700 transition-all">Treats</button>
            <button onclick="switchTab('ai')" id="tab-ai" class="flex-1 min-w-[100px] py-4 text-[10px] uppercase tracking-wider font-bold text-amber-700 transition-all border-l border-amber-200/50">üíé Blue Hive AI</button>
        </div>

        <div class="flex-grow p-4 md:p-6 pb-20">
            <div class="card rounded-2xl shadow-xl overflow-hidden mb-8">
                
                <!-- Ticket Section -->
                <div id="section-tickets" class="p-5 space-y-6">
                    <div class="bg-gradient-to-r from-orange-50 to-amber-50 rounded-xl p-4 border-2 border-orange-200 shadow-sm">
                        <div class="flex items-center justify-between gap-4">
                            <div class="flex-1">
                                <label class="block text-[11px] font-black text-orange-900 mb-2 uppercase tracking-tight">Shop Ticket Price?</label>
                                <input type="number" id="quickCost" placeholder="e.g. 150000" class="w-full px-4 py-2 rounded-lg border-2 border-orange-200 focus:border-orange-500 outline-none transition-all text-sm">
                            </div>
                            <div id="calcBoughtCount" class="text-lg font-black text-orange-600 px-4 py-2 bg-white rounded-lg border-2 border-orange-100 min-w-[110px] text-center">0</div>
                        </div>
                    </div>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-xs font-bold text-amber-900 mb-1 uppercase">Owned</label>
                            <input type="number" id="owned" value="0" class="w-full px-4 rounded-xl border-2 border-amber-100 focus:border-amber-400 outline-none">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-amber-900 mb-1 uppercase">Amount to Buy</label>
                            <input type="number" id="toBuy" value="1" class="w-full px-4 rounded-xl border-2 border-amber-100 focus:border-amber-400 outline-none">
                        </div>
                    </div>
                    <div class="bee-gradient rounded-xl p-5 shadow-md text-white text-center">
                        <div id="totalCost" class="text-xl font-bold">100,000 Honey</div>
                    </div>
                </div>

                <!-- Treats Section -->
                <div id="section-treats" class="hidden p-5 space-y-6">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-amber-900 mb-2 uppercase">Target Lvl</label>
                            <input type="number" id="targetLevel" value="10" class="w-full px-4 rounded-xl border-2 border-amber-100 focus:border-amber-400">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-amber-900 mb-2 uppercase">Bee Count</label>
                            <input type="number" id="beeCount" value="50" class="w-full px-4 rounded-xl border-2 border-amber-100 focus:border-amber-400">
                        </div>
                    </div>
                    <div id="treatHoneyResult" class="bg-white border-2 border-amber-100 rounded-xl p-5 text-center text-2xl font-bold text-amber-900">0</div>
                </div>

                <!-- AI Hive Improver Section -->
                <div id="section-ai" class="hidden p-5 space-y-6">
                    <!-- Scanner Tool -->
                    <div class="bg-blue-50 border border-blue-100 rounded-2xl p-4">
                        <h2 class="text-sm font-bold text-blue-900 mb-3 flex items-center gap-2">
                            <span>üì∏</span> Hive Scanner
                        </h2>
                        <div id="uploadArea" class="border-2 border-dashed border-blue-300 rounded-xl p-6 flex flex-col items-center justify-center bg-white hover:bg-blue-50 transition-all cursor-pointer">
                            <!-- Added capture="environment" for iOS camera preference -->
                            <input type="file" id="imageInput" accept="image/*" capture="environment" class="hidden">
                            <p class="text-[10px] font-bold text-blue-500 uppercase">Tap to Take Photo or Upload</p>
                        </div>
                        <div id="imagePreviewContainer" class="hidden mt-4 space-y-3">
                            <img id="imagePreview" class="w-full rounded-lg h-32 object-cover border-2 border-blue-400">
                            <button id="analyzeBtn" class="w-full bg-blue-600 py-3 rounded-xl text-white font-bold text-xs uppercase shadow-md active:scale-95 transition-all">
                                Analyze My Hive
                            </button>
                        </div>
                    </div>

                    <!-- Expert Chat Bot -->
                    <div class="space-y-3">
                        <div id="chatWindow" class="bg-slate-50 border-2 border-slate-100 rounded-2xl p-4 h-64 overflow-y-auto space-y-4 flex flex-col">
                            <div class="chat-bubble-ai p-3 text-xs text-blue-800 self-start max-w-[85%]">
                                Hello! I'm your BSS mentor. Tap the camera to send me your Amulets or Hive!
                            </div>
                        </div>

                        <div class="bg-white border-2 border-slate-100 rounded-2xl p-2 shadow-sm">
                            <div id="attachmentPreview" class="hidden flex items-center gap-2 p-2 mb-2 bg-blue-50 rounded-xl">
                                <img id="attachedImageImg" class="image-attachment-preview">
                                <button onclick="removeAttachment()" class="text-red-400 p-1">‚úï</button>
                            </div>
                            <div class="flex items-end gap-2">
                                <button id="chatCameraBtn" class="p-3 text-blue-400 hover:bg-blue-50 rounded-xl transition-all">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                                </button>
                                <input type="file" id="chatImageInput" accept="image/*" capture="environment" class="hidden">
                                <textarea id="chatInput" placeholder="Ask a question..." class="flex-grow p-2 text-sm outline-none bg-transparent min-h-[44px] max-h-32 resize-none"></textarea>
                                <button id="sendMsgBtn" class="p-3 text-blue-600">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" /></svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script>
        const apiKey = "";
        let pendingImageData = null;

        // Tab Switching Logic
        function switchTab(tab) {
            ['tickets', 'treats', 'ai'].forEach(t => {
                document.getElementById(`section-${t}`).classList.add('hidden');
                document.getElementById(`tab-${t}`).classList.remove('tab-active');
            });
            document.getElementById(`section-${tab}`).classList.remove('hidden');
            document.getElementById(`tab-${tab}`).classList.add('tab-active');
        }

        // --- CAMERA & FILE HANDLING FIXES FOR IOS ---
        const uploadArea = document.getElementById('uploadArea');
        const imageInput = document.getElementById('imageInput');
        const chatCameraBtn = document.getElementById('chatCameraBtn');
        const chatImageInput = document.getElementById('chatImageInput');

        // iOS requires direct interaction to trigger file picker reliably
        uploadArea.addEventListener('click', () => imageInput.click());
        chatCameraBtn.addEventListener('click', () => chatImageInput.click());

        function handleImageUpload(input, previewImg, container) {
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (re) => {
                    if (previewImg) previewImg.src = re.target.result;
                    if (container) container.classList.remove('hidden');
                    if (input === chatImageInput) {
                        pendingImageData = re.target.result.split(',')[1];
                        document.getElementById('attachedImageImg').src = re.target.result;
                        document.getElementById('attachmentPreview').classList.remove('hidden');
                    }
                };
                reader.readAsDataURL(file);
            };
        }

        handleImageUpload(imageInput, document.getElementById('imagePreview'), document.getElementById('imagePreviewContainer'));
        handleImageUpload(chatImageInput, null, null);

        function removeAttachment() {
            pendingImageData = null;
            document.getElementById('attachmentPreview').classList.add('hidden');
            chatImageInput.value = "";
        }

        // --- AI LOGIC ---
        async function sendToAI(prompt, base64Image = null) {
            const chatBody = {
                contents: [{ role: "user", parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: "BSS Master Expert. Give short, direct answers." }] }
            };
            if (base64Image) {
                chatBody.contents[0].parts.push({ inlineData: { mimeType: "image/png", data: base64Image } });
            }

            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(chatBody)
                });
                const data = await res.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || "No response.";
            } catch (e) { return "Connection Error."; }
        }

        const chatWindow = document.getElementById('chatWindow');
        const chatInput = document.getElementById('chatInput');

        function appendMessage(role, text, imageSrc = null) {
            const div = document.createElement('div');
            div.className = role === 'ai' ? 'chat-bubble-ai p-3 text-xs text-blue-800 self-start max-w-[85%]' : 'chat-bubble-user p-3 text-xs text-amber-900 self-end max-w-[85%]';
            if (imageSrc) {
                const img = document.createElement('img');
                img.src = imageSrc;
                img.className = "w-full rounded mb-2 border border-amber-200";
                div.appendChild(img);
            }
            const span = document.createElement('span');
            span.innerText = text;
            div.appendChild(span);
            chatWindow.appendChild(div);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        document.getElementById('sendMsgBtn').onclick = async () => {
            const msg = chatInput.value.trim();
            const currentImgData = pendingImageData;
            const currentImgSrc = currentImgData ? document.getElementById('attachedImageImg').src : null;
            
            if (!msg && !currentImgData) return;

            appendMessage('user', msg || "[Image]", currentImgSrc);
            chatInput.value = "";
            removeAttachment();

            const response = await sendToAI(msg || "Analyze image", currentImgData);
            appendMessage('ai', response);
        };

        document.getElementById('analyzeBtn').onclick = async () => {
            const btn = document.getElementById('analyzeBtn');
            btn.innerText = "Scanning...";
            const scanImg = document.getElementById('imagePreview').src;
            appendMessage('user', "[Scanning Hive]", scanImg);
            const response = await sendToAI("Analyze hive efficiency", scanImg.split(',')[1]);
            appendMessage('ai', response);
            btn.innerText = "Analyze My Hive";
        };

        // --- TICKET CALCULATOR ---
        const quickCostIn = document.getElementById('quickCost');
        const calcBoughtEl = document.getElementById('calcBoughtCount');
        const ownedInput = document.getElementById('owned');
        const toBuyInput = document.getElementById('toBuy');

        quickCostIn.oninput = () => {
            const p = parseFloat(quickCostIn.value) || 0;
            if (p < 100000) return;
            const x = (p - 100000) / 1000;
            const n = Math.round(p < 500000 ? Math.pow(x, 1/1.2) : Math.pow(x, 1/1.7));
            calcBoughtEl.innerText = n;
            ownedInput.value = n;
            updateTickets();
        };

        function updateTickets() {
            const o = parseInt(ownedInput.value) || 0;
            const b = parseInt(toBuyInput.value) || 0;
            let t = 0;
            for (let i = 0; i < b; i++) {
                let n = o + i;
                t += n < 501 ? 100000 + (1000 * Math.pow(n, 1.2)) : 100000 + (1000 * Math.pow(n, 1.7));
            }
            document.getElementById('totalCost').innerText = Math.floor(t).toLocaleString() + " Honey";
        }
        ownedInput.oninput = updateTickets;
        toBuyInput.oninput = updateTickets;
    </script>
</body>
</html>